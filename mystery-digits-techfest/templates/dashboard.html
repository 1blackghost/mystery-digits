<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Web Page</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>

<p>logged in</p>
<p>current level: <span id="level">{{lvl}}</span></p>
<img id="profileImage" src="{{filename}}">
<p>chances left : <span id="tries">{{tries}}</span></p>

<p style="color:red" id="error"></p>
<form id="gameForm">
    <label for="levelInput">Enter Digits:</label>
    <input type="number" id="val" name="levelInput" required>
    <button type="submit">Submit</button>
</form>

<!-- Leaderboard table -->
<table id="leaderboardTable" border="1">
    <thead>
        <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Level</th>
            <th>Time</th>
            <th>Profile</th>
        </tr>
    </thead>
    <tbody id="leaderboardBody">
        <!-- Leaderboard rows will be added dynamically here -->
    </tbody>
</table>

<script>
$(document).ready(function(){
    // Function to get and display leaderboard
    function getLeaderboard() {
        $.ajax({
            type: 'GET',
            url: '/getL',
            success: function(response){
                console.log("Success. Response:", response);

                // Clear existing leaderboard rows
                $("#leaderboardBody").empty();

                // Check if the response is an array
                if (Array.isArray(response)) {
                    // Add new rows to the leaderboard table
                    $.each(response, function(index, entry) {
                        // Accessing the inner array elements
                        $("#leaderboardBody").append(
                            "<tr><td>" + entry[0] + "</td>" +
                            "<td>" + entry[1] + "</td>" +
                            "<td>" + entry[2] + "</td>" +
                            "<td>" + entry[3] + "</td>" +
                            "<td><img src='" + entry[4] + "' alt='Profile'></td></tr>"
                        );
                    });
                } else {
                    console.error("Invalid response format. Expected an array.");
                }
            },
            error: function(error){
                console.error("Error fetching leaderboard: ", error);
            }
        });
    }

    // Call the function to get and display the leaderboard on page load
    getLeaderboard();

    // Set up interval to update leaderboard every 2 seconds
    setInterval(function() {
        getLeaderboard();
    }, 2000);

    // Submit form function remains unchanged
    $("#gameForm").submit(function(e){
        e.preventDefault();

        var val = $("#val").val();

        $.ajax({
            type: 'POST',
            url: '/game',
            data: { val: val },
            success: function(response){
                if (response.continue === "false"){
                    window.location = "/ended";
                }
                $("#profileImage").fadeOut(300, function() {
                    $(this).attr("src", response.filepath).fadeIn(300);
                });

                $("#level").fadeOut(300, function() {
                    $(this).text(response.level).fadeIn(300);
                });

                $("#tries").fadeOut(300, function() {
                    $(this).text(response.tries).fadeIn(300);
                });

                $("#error").text("Success").fadeIn(300).delay(2000).fadeOut(300);
            },
            error: function(error){
                if (error.responseJSON.continue === "false"){
                    document.body.innerHTML = '';

                    window.location = "/ended";
                }
                $("#error").fadeOut(300, function() {
                    $(this).text("Wrong guess").fadeIn(300).delay(2000).fadeOut(300);
                });
                if (error.responseJSON && error.responseJSON.tries) {
                    $("#tries").fadeOut(300, function() {
                        $(this).text(error.responseJSON.tries).fadeIn(300);
                    });
                }
            }
        });
    });
});
</script>

</body>
</html>
